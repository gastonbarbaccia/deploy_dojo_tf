pipeline {
    agent any
    parameters {
        string(name: 'AWS_ACCESS_KEY_ID', defaultValue: '', description: 'AWS Access Key')
        password(name: 'AWS_SECRET_ACCESS_KEY', defaultValue: '', description: 'AWS Secret Key')
        string(name: 'AWS_REGION', defaultValue: 'us-east-1', description: 'AWS Region')
        string(name: 'INSTANCE_NAME', defaultValue: 'dojo', description: 'EC2 Name')
        string(name: 'INSTANCE_TYPE', defaultValue: 't2.medium', description: 'EC2 Instance type')
    }
    environment {
        AWS_ACCESS_KEY_ID     = "${params.AWS_ACCESS_KEY_ID}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY}"
        AWS_REGION            = "${params.AWS_REGION}"
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/gastonbarbaccia/deploy_dojo_tf.git'
            }
        }
        stage('Terraform Init') {
            steps {
                sh 'terraform init'
                sh 'terraform version'
                sh 'terraform fmt -check'
                sh 'terraform validate'
            }
        }
        stage('Terraform Apply') {
            steps {
                sh """
                terraform apply -auto-approve \
                    -var aws_region=${AWS_REGION} \
                    -var instance_name=${params.INSTANCE_NAME} \
                    -var instance_type=${params.INSTANCE_TYPE} \
                """
            }
        }
    }
}
